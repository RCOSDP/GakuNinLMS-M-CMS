<html>

<head>
  <title>chilospeech wasm version sample page</title>
</head>

<body>
  <div id="react_app"></div>
</body>

<script src="ffmpeg.min.js"></script>
<script src="browser.js"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js" crossorigin></script>

<script>
const {setRoot, getPptx} = ppt2video;

let dirHandle = null;
let pptx = null;

async function openDirectory() {
  dirHandle = await window.showDirectoryPicker();
  setRoot(dirHandle);
}

async function getPptxList() {
  const ret = [];
  const re = /.(pptx|PPTX)/;
  for await (const dirent of dirHandle.entries()) {
    const match = dirent[0].match(re);
    if (match) {
      ret.push(dirent[0]);
    }
  }
  return ret;
}

async function openPptx(filename) {
  pptx = await getPptx(filename);
  await pptx.init();
  pptx.zipControl('start');
}

async function createImportJson() {
  const option = {
    importJsonOnly: true,
  };
  await pptx.process(option);
}

function getTopicList() {
  const ret = [];
  for (const section of pptx.sections) {
    ret.push(section.topics[0].name);
  }
  return ret;
}

async function oneTopic(num) {
  const targetTopic = pptx.sections[num].topics[0];
  const option = {
    videoOnly: true,
    targetTopic,
  };
  await pptx.process(option);
}

async function flushZip() {
  await pptx.zipControl('flush');
}
</script>

<script type="text/babel">
const { useState, useEffect } = React;

const steps = {
  step1: 1,
  step2: 2,
  step3: 3,
  step35: 4,
  step4: 5,
};

function Message(props) {
  if (props.msg) {
    return (
      <div>
        <br/>
        <textarea readOnly="readonly" rows="5" cols="80" defaultValue={props.msg}></textarea>
      </div>
    );
  }
  return null;
}

function App() {
  const [step, setStep] = useState(steps.step1);
  const [pptxList, setPptxList] = useState([]);
  const [topicList, setTopicList] = useState([]);
  const [filename, setFilename] = useState(null);
  const [error1, setError1] = useState(null);
  const [error2, setError2] = useState(null);
  const [error3, setError3] = useState(null);
  const [error4, setError4] = useState(null);

  async function handleStep1OpenDirectory() {
    try {
      setError1(null);
      await openDirectory();
      readDirectory();
    } catch(e) {
      setError1('ディレクトリを開くことができませんでした。\n' + e.message);
    }
  }

  async function readDirectory() {
    const list = await getPptxList();
    setPptxList(list);
    setStep(steps.step2);
  }

  function handleFilename(e) {
    setFilename(e.target.value);
  }

  async function handleStep2Next() {
    try {
      setError2(null);
      await openPptx(filename);
      const list = getTopicList();
      setTopicList(list);
      setStep(steps.step3);
    } catch(e) {
      setError2(e.toString());
    }
  }

  function progress(list, i) {
    const progress = list.map((name, index) => (index <= i?'✓ ':'') + name);
    setTopicList(progress);
  }

  async function handleStep3Start() {
    try {
      setError3(null);
      setStep(steps.step35);
      const list = getTopicList();
      const len = list.length;
      await createImportJson();
      for (let i = 0; i < len; i++) {
        await oneTopic(i);
        progress(list, i);
      }
      setStep(steps.step4);
    } catch(e){
      setError3(e.message);
      setStep(steps.step3);
    }
  }

  async function handleStep4Save() {
    try {
      setError4(null);
      await flushZip();
      setPptxList([]);
      setFilename(null);
      setTopicList([]);
      readDirectory();
    } catch(e){
      setError4('zipファイルの保存に失敗しました。\n' + e.message);
    }
  }

  return (
    <div>
      <h2> step1: パワーポイントファイルを含むディレクトリを開きます。</h2>
      <button onClick={handleStep1OpenDirectory} disabled={step !== steps.step1}>ディレクトリを開く</button>
      <Message msg={error1} />
      <h2> step2: パワーポイントファイルを選択します。</h2>
      <form>
        {pptxList.map((filename, index) =>
          <div key={index}>
            <input type="radio" name="pptx" value={filename} onClick={handleFilename} /> {filename}
          </div>
        )}
      </form>
      <button onClick={handleStep2Next} disabled={step !== steps.step2 || filename === null}>次へ</button>
      <Message msg={error2} />
      <h2> step3: Import JSONファイル及び各トピックのビデオファイルを作成します。</h2>
      {topicList.map((topicname, index) =>
        <p key={index}>{topicname}</p>
      )}
      <button onClick={handleStep3Start} disabled={step !== steps.step3}>開始</button>
      <Message msg={error3} />
      <h2> step4: zipファイルを保存します。</h2>
      <button onClick={handleStep4Save} disabled={step !== steps.step4}>保存</button>
      <Message msg={error4} />
    </div>
  )
}

const domContainer = document.querySelector('#react_app');
const root = ReactDOM.createRoot(domContainer);
root.render(
  <App />
);

</script>
